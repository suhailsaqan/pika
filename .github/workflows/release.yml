name: release

on:
  push:
    tags:
      - "pika/v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  approve-release:
    runs-on: ubuntu-latest
    environment:
      name: release
    steps:
      - name: Enforce allowed release actors
        run: |
          set -euo pipefail
          case "${GITHUB_ACTOR}" in
            justinmoon|futurepaul|benthecarman|AnthonyRonning) ;;
            *)
              echo "error: actor '${GITHUB_ACTOR}' is not allowed to run release workflow"
              exit 1
              ;;
          esac
      - run: echo "release approved"

  check:
    needs: approve-release
    runs-on: blacksmith-16vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-nix-v1-${{ runner.os }}
          path: /nix
      - name: Fix /nix ownership
        run: |
          if [ -d /nix ] && [ "$(stat -c %u /nix)" != "$(id -u)" ]; then
            sudo chown -R "$(id -u):$(id -g)" /nix
          fi
      - uses: nixbuild/nix-quick-install-action@v30

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-home-v1-${{ runner.os }}
          path: ~/.cargo
      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-target-v1-${{ runner.os }}
          path: target

      - name: Validate tag matches VERSION
        run: |
          set -euo pipefail
          if [ "${GITHUB_REF_TYPE}" != "tag" ]; then
            echo "error: release workflow must run on a tag ref"
            exit 1
          fi
          expected_tag="pika/v$(./scripts/version-read --name)"
          if [ "${GITHUB_REF_NAME}" != "$expected_tag" ]; then
            echo "error: tag/version mismatch: ref=${GITHUB_REF_NAME}, expected=${expected_tag}"
            exit 1
          fi

      - run: nix develop .#default -c just pre-merge-pika

  build-android:
    needs: check
    runs-on: blacksmith-16vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-nix-v1-${{ runner.os }}
          path: /nix
      - name: Fix /nix ownership
        run: |
          if [ -d /nix ] && [ "$(stat -c %u /nix)" != "$(id -u)" ]; then
            sudo chown -R "$(id -u):$(id -g)" /nix
          fi
      - uses: nixbuild/nix-quick-install-action@v30

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-home-v1-${{ runner.os }}
          path: ~/.cargo
      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-target-v1-${{ runner.os }}
          path: target

      - name: Validate tag matches VERSION
        run: |
          set -euo pipefail
          expected_tag="pika/v$(./scripts/version-read --name)"
          if [ "${GITHUB_REF_NAME}" != "$expected_tag" ]; then
            echo "error: tag/version mismatch: ref=${GITHUB_REF_NAME}, expected=${expected_tag}"
            exit 1
          fi

      - name: Build signed release APK
        env:
          AGE_SECRET_KEY: ${{ secrets.AGE_SECRET_KEY }}
        run: nix develop .#default -c just android-release

      - uses: actions/upload-artifact@v4
        with:
          name: release-android
          path: dist/*.apk
          if-no-files-found: error

  build-macos:
    needs: check
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - uses: Swatinem/rust-cache@v2

      - name: Validate tag matches VERSION
        run: |
          set -euo pipefail
          expected_tag="pika/v$(./scripts/version-read --name)"
          if [ "${GITHUB_REF_NAME}" != "$expected_tag" ]; then
            echo "error: tag/version mismatch: ref=${GITHUB_REF_NAME}, expected=${expected_tag}"
            exit 1
          fi

      - name: Build macOS universal DMG
        run: ./scripts/build-macos-release

      - uses: actions/upload-artifact@v4
        with:
          name: release-macos
          path: dist/*.dmg
          if-no-files-found: error

  publish:
    needs: [build-android, build-macos]
    runs-on: blacksmith-16vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: release-android
          path: dist

      - uses: actions/download-artifact@v4
        with:
          name: release-macos
          path: dist

      - name: Validate tag matches VERSION
        run: |
          set -euo pipefail
          expected_tag="pika/v$(./scripts/version-read --name)"
          if [ "${GITHUB_REF_NAME}" != "$expected_tag" ]; then
            echo "error: tag/version mismatch: ref=${GITHUB_REF_NAME}, expected=${expected_tag}"
            exit 1
          fi

      - name: Generate checksums
        run: sha256sum dist/*.apk dist/*.dmg > dist/SHA256SUMS

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Pika ${{ github.ref_name }}
          generate_release_notes: true
          overwrite_files: true
          files: |
            dist/*.apk
            dist/*.dmg
            dist/SHA256SUMS

  publish-zapstore:
    needs: [build-android, publish]
    runs-on: blacksmith-16vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - name: Check Zapstore signing secret
        id: zapstore_secret
        run: |
          set -euo pipefail
          if [ -f secrets/zapstore-signing.env.age ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
            echo "note: secrets/zapstore-signing.env.age not found; skipping Zapstore publish"
          fi

      - uses: useblacksmith/stickydisk@v1
        if: steps.zapstore_secret.outputs.present == 'true'
        with:
          key: ${{ github.repository }}-nix-v1-${{ runner.os }}
          path: /nix
      - name: Fix /nix ownership
        if: steps.zapstore_secret.outputs.present == 'true'
        run: |
          if [ -d /nix ] && [ "$(stat -c %u /nix)" != "$(id -u)" ]; then
            sudo chown -R "$(id -u):$(id -g)" /nix
          fi
      - uses: nixbuild/nix-quick-install-action@v30
        if: steps.zapstore_secret.outputs.present == 'true'

      - uses: actions/download-artifact@v4
        if: steps.zapstore_secret.outputs.present == 'true'
        with:
          name: release-android
          path: dist

      - name: Validate tag matches VERSION
        if: steps.zapstore_secret.outputs.present == 'true'
        run: |
          set -euo pipefail
          expected_tag="pika/v$(./scripts/version-read --name)"
          if [ "${GITHUB_REF_NAME}" != "$expected_tag" ]; then
            echo "error: tag/version mismatch: ref=${GITHUB_REF_NAME}, expected=${expected_tag}"
            exit 1
          fi

      - name: Publish to Zapstore
        if: steps.zapstore_secret.outputs.present == 'true'
        env:
          AGE_SECRET_KEY: ${{ secrets.AGE_SECRET_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          set +x
          apk_count="$(find dist -maxdepth 1 -type f -name '*.apk' | wc -l | xargs)"
          if [ "$apk_count" -ne 1 ]; then
            echo "error: expected exactly one APK artifact in dist/, found $apk_count"
            find dist -maxdepth 1 -type f -name '*.apk' -print
            exit 1
          fi
          apk_path="$(find dist -maxdepth 1 -type f -name '*.apk' | head -n 1)"
          nix develop .#default -c ./scripts/zapstore-publish "$apk_path" "https://github.com/${GITHUB_REPOSITORY}"

  announce-release:
    needs: publish
    runs-on: blacksmith-16vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - name: Ensure announcement signing secret exists
        run: |
          set -euo pipefail
          if [ ! -f secrets/zapstore-signing.env.age ]; then
            echo "error: missing secrets/zapstore-signing.env.age (required for release announcement signing)"
            exit 1
          fi

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-nix-v1-${{ runner.os }}
          path: /nix
      - name: Fix /nix ownership
        run: |
          if [ -d /nix ] && [ "$(stat -c %u /nix)" != "$(id -u)" ]; then
            sudo chown -R "$(id -u):$(id -g)" /nix
          fi
      - uses: nixbuild/nix-quick-install-action@v30

      - name: Publish release announcement (kind 1)
        env:
          AGE_SECRET_KEY: ${{ secrets.AGE_SECRET_KEY }}
        run: |
          set -euo pipefail
          set +x
          repo_url="https://github.com/${GITHUB_REPOSITORY}"
          nix develop .#default -c ./scripts/post-release-announcement "${GITHUB_REF_NAME}" "$repo_url"
