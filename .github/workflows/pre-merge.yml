name: pre-merge

on:
  pull_request:
    branches: [master]
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: "Which lane to run"
        type: choice
        options:
          - pre-merge
          - nightly
        default: pre-merge

jobs:
  check-pika:
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'pre-merge')
    runs-on: depot-ubuntu-24.04-16
    environment:
      name: ${{ github.event_name == 'pull_request' && github.actor != 'justinmoon' && github.actor != 'futurepaul' && 'ci-approval' || 'ci-auto' }}
    steps:
      - uses: actions/checkout@v4
      - uses: nixbuild/nix-quick-install-action@v30
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - uses: Swatinem/rust-cache@v2
      - run: nix develop .#default -c just pre-merge-pika

  check-rmp:
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'pre-merge')
    runs-on: depot-ubuntu-24.04-16
    environment:
      name: ${{ github.event_name == 'pull_request' && github.actor != 'justinmoon' && github.actor != 'futurepaul' && 'ci-approval' || 'ci-auto' }}
    steps:
      - uses: actions/checkout@v4
      - uses: nixbuild/nix-quick-install-action@v30
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - uses: Swatinem/rust-cache@v2
      - run: nix develop .#rmp -c just pre-merge-rmp

  pre-merge:
    if: always() && (github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'pre-merge'))
    needs: [check-pika, check-rmp]
    runs-on: depot-ubuntu-24.04
    steps:
      - run: |
          if [[ "${{ needs.check-pika.result }}" != "success" ]]; then
            echo "check-pika failed"
            exit 1
          fi
          if [[ "${{ needs.check-rmp.result }}" != "success" ]]; then
            echo "check-rmp failed"
            exit 1
          fi

  nightly-linux:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'nightly')
    runs-on: depot-ubuntu-24.04-16
    steps:
      - uses: actions/checkout@v4
      - uses: nixbuild/nix-quick-install-action@v30
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - uses: Swatinem/rust-cache@v2
      - run: nix develop .#default -c just rmp-nightly-linux

  nightly-macos-ios:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'nightly')
    runs-on: depot-macos-15
    steps:
      - uses: actions/checkout@v4
      - uses: nixbuild/nix-quick-install-action@v30
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - uses: Swatinem/rust-cache@v2
      - run: nix develop .#default -c just rmp-nightly-macos

  nightly:
    if: always() && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'nightly'))
    needs: [nightly-linux, nightly-macos-ios]
    runs-on: depot-ubuntu-24.04
    steps:
      - run: |
          if [[ "${{ needs.nightly-linux.result }}" != "success" ]]; then
            echo "nightly-linux failed"
            exit 1
          fi
          if [[ "${{ needs.nightly-macos-ios.result }}" != "success" ]]; then
            echo "nightly-macos-ios failed"
            exit 1
          fi
