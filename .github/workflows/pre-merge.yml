name: pre-merge

on:
  pull_request:
    branches: [master]
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: "Which lane to run"
        type: choice
        options:
          - pre-merge
          - nightly
        default: pre-merge

jobs:
  detect-changes:
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'pre-merge')
    runs-on: ubuntu-latest
    outputs:
      pika: ${{ steps.filter.outputs.pika || 'true' }}
      marmotd: ${{ steps.filter.outputs.marmotd || 'true' }}
      rmp: ${{ steps.filter.outputs.rmp || 'true' }}
      notifications: ${{ steps.filter.outputs.notifications || 'true' }}
    steps:
      - uses: dorny/paths-filter@v3
        if: github.event_name == 'pull_request'
        id: filter
        with:
          filters: |
            pika:
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'flake.nix'
              - 'flake.lock'
              - 'nix/**'
              - 'justfile'
              - '.github/**'
              - 'rust/**'
              - 'cli/**'
              - 'crates/pika-desktop/**'
              - 'crates/pika-media/**'
              - 'crates/pika-nse/**'
              - 'crates/pika-tls/**'
              - 'uniffi-bindgen/**'
              - 'android/**'
              - 'ios/**'
              - 'docs/**'
              - 'scripts/**'
              - 'tools/**'
            marmotd:
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'flake.nix'
              - 'flake.lock'
              - 'nix/**'
              - 'justfile'
              - '.github/workflows/pre-merge.yml'
              - 'crates/marmotd/**'
              - 'openclaw-marmot/**'
              - 'crates/pika-media/**'
              - 'crates/pika-tls/**'
            rmp:
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'flake.nix'
              - 'flake.lock'
              - 'nix/**'
              - 'justfile'
              - '.github/workflows/pre-merge.yml'
              - 'crates/rmp-cli/**'
            notifications:
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'flake.nix'
              - 'flake.lock'
              - 'nix/**'
              - 'justfile'
              - '.github/workflows/pre-merge.yml'
              - 'crates/pika-notifications/**'
              - 'crates/pika-server/**'

  check-pika:
    needs: [detect-changes]
    if: needs.detect-changes.outputs.pika == 'true'
    runs-on: blacksmith-16vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-nix-v1-${{ runner.os }}
          path: /nix
      - name: Fix /nix ownership
        run: |
          if [ -d /nix ] && [ "$(stat -c %u /nix)" != "$(id -u)" ]; then
            sudo chown -R "$(id -u):$(id -g)" /nix
          fi
      - uses: nixbuild/nix-quick-install-action@v30

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-home-v1-${{ runner.os }}
          path: ~/.cargo
      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-target-v1-${{ runner.os }}
          path: target

      - run: nix develop .#default -c just pre-merge-pika

  check-marmotd:
    needs: [detect-changes]
    if: needs.detect-changes.outputs.marmotd == 'true'
    runs-on: blacksmith-16vcpu-ubuntu-2404
    environment:
      name: ${{ github.event_name == 'pull_request' && github.actor != 'justinmoon' && github.actor != 'futurepaul' && github.actor != 'AnthonyRonning' && github.actor != 'benthecarman' && 'ci-approval' || 'ci-auto' }}
    steps:
      - uses: actions/checkout@v4

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-nix-v1-${{ runner.os }}
          path: /nix
      - name: Fix /nix ownership
        run: |
          if [ -d /nix ] && [ "$(stat -c %u /nix)" != "$(id -u)" ]; then
            sudo chown -R "$(id -u):$(id -g)" /nix
          fi
      - uses: nixbuild/nix-quick-install-action@v30

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-home-v1-${{ runner.os }}
          path: ~/.cargo
      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-target-v1-${{ runner.os }}
          path: target

      - run: nix develop .#default -c just pre-merge-marmotd

  check-rmp:
    needs: [detect-changes]
    if: needs.detect-changes.outputs.rmp == 'true'
    runs-on: blacksmith-16vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-nix-v1-${{ runner.os }}
          path: /nix
      - name: Fix /nix ownership
        run: |
          if [ -d /nix ] && [ "$(stat -c %u /nix)" != "$(id -u)" ]; then
            sudo chown -R "$(id -u):$(id -g)" /nix
          fi
      - uses: nixbuild/nix-quick-install-action@v30

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-home-v1-${{ runner.os }}
          path: ~/.cargo
      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-target-v1-${{ runner.os }}
          path: target

      - run: nix develop .#rmp -c just pre-merge-rmp

  check-notifications:
    needs: [detect-changes]
    if: needs.detect-changes.outputs.notifications == 'true'
    runs-on: blacksmith-16vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-nix-v1-${{ runner.os }}
          path: /nix
      - name: Fix /nix ownership
        run: |
          if [ -d /nix ] && [ "$(stat -c %u /nix)" != "$(id -u)" ]; then
            sudo chown -R "$(id -u):$(id -g)" /nix
          fi
      - uses: nixbuild/nix-quick-install-action@v30

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-home-v1-${{ runner.os }}
          path: ~/.cargo
      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-target-v1-${{ runner.os }}
          path: target

      - run: nix develop .#default -c just pre-merge-notifications

  pre-merge:
    if: always() && (github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'pre-merge'))
    needs: [detect-changes, check-pika, check-marmotd, check-rmp, check-notifications]
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate lane results
        run: |
          failed=""
          for lane in pika marmotd rmp notifications; do
            result=""
            case "$lane" in
              pika)          result="${{ needs.check-pika.result }}" ;;
              marmotd)       result="${{ needs.check-marmotd.result }}" ;;
              rmp)           result="${{ needs.check-rmp.result }}" ;;
              notifications) result="${{ needs.check-notifications.result }}" ;;
            esac
            if [[ "$result" == "success" || "$result" == "skipped" ]]; then
              echo "check-$lane: $result (ok)"
            else
              echo "check-$lane: $result (FAILED)"
              failed="${failed}check-${lane} "
            fi
          done
          if [[ -n "$failed" ]]; then
            echo "::error::Failed lanes: $failed"
            exit 1
          fi

  nightly-linux:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'nightly')
    runs-on: blacksmith-16vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-nix-v1-${{ runner.os }}
          path: /nix
      - name: Fix /nix ownership
        run: |
          if [ -d /nix ] && [ "$(stat -c %u /nix)" != "$(id -u)" ]; then
            sudo chown -R "$(id -u):$(id -g)" /nix
          fi
      - uses: nixbuild/nix-quick-install-action@v30

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-home-v1-${{ runner.os }}
          path: ~/.cargo
      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-target-v1-${{ runner.os }}
          path: target

      - run: nix develop .#default -c just rmp-nightly-linux

  nightly-pika:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'nightly')
    runs-on: blacksmith-16vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-nix-v1-${{ runner.os }}
          path: /nix
      - name: Fix /nix ownership
        run: |
          if [ -d /nix ] && [ "$(stat -c %u /nix)" != "$(id -u)" ]; then
            sudo chown -R "$(id -u):$(id -g)" /nix
          fi
      - uses: nixbuild/nix-quick-install-action@v30

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-home-v1-${{ runner.os }}
          path: ~/.cargo
      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-target-v1-${{ runner.os }}
          path: target

      - run: nix develop .#default -c just nightly-pika-e2e

  nightly-marmotd:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'nightly')
    runs-on: blacksmith-16vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-nix-v1-${{ runner.os }}
          path: /nix
      - name: Fix /nix ownership
        run: |
          if [ -d /nix ] && [ "$(stat -c %u /nix)" != "$(id -u)" ]; then
            sudo chown -R "$(id -u):$(id -g)" /nix
          fi
      - uses: nixbuild/nix-quick-install-action@v30

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-home-v1-${{ runner.os }}
          path: ~/.cargo
      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-target-v1-${{ runner.os }}
          path: target

      - run: nix develop .#default -c just nightly-marmotd

  nightly-pika-ui-android:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'nightly')
    runs-on: blacksmith-16vcpu-ubuntu-2404
    steps:
      - uses: actions/checkout@v4

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-nix-v1-${{ runner.os }}
          path: /nix
      - name: Fix /nix ownership
        run: |
          if [ -d /nix ] && [ "$(stat -c %u /nix)" != "$(id -u)" ]; then
            sudo chown -R "$(id -u):$(id -g)" /nix
          fi
      - uses: nixbuild/nix-quick-install-action@v30

      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-home-v1-${{ runner.os }}
          path: ~/.cargo
      - uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ github.repository }}-cargo-target-v1-${{ runner.os }}
          path: target

      - run: |
          nix develop .#default -c ./tools/android-avd-ensure
          # Run deterministic Android UI E2E in CI; audio-call E2E remains opt-in due flakiness.
          PIKA_ANDROID_E2E_TEST_CLASS="com.pika.app.NostrConnectIntentTest,com.pika.app.PikaE2eUiTest#e2e_deployedRustBot_pingPong" \
          PIKA_ANDROID_FORCE_GUI=0 \
          PIKA_ANDROID_EMULATOR_ARGS="-no-window" \
          nix develop .#default -c just android-ui-e2e-local

  nightly-primal-ios-interop:
    if: (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'nightly')) && vars.PIKA_NIGHTLY_PRIMAL_INTEROP == '1'
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - uses: nixbuild/nix-quick-install-action@v30
      - run: nix develop .#default -c just nightly-primal-ios-interop

  nightly:
    if: always() && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'nightly'))
    needs: [nightly-linux, nightly-pika, nightly-marmotd, nightly-pika-ui-android, nightly-primal-ios-interop]
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Check nightly results
        id: check
        run: |
          failed=""
          if [[ "${{ needs.nightly-linux.result }}" != "success" ]]; then
            echo "nightly-linux failed"
            failed="${failed}- **nightly-linux**: ${{ needs.nightly-linux.result }}\n"
          fi
          if [[ "${{ needs.nightly-pika.result }}" != "success" ]]; then
            echo "nightly-pika failed"
            failed="${failed}- **nightly-pika**: ${{ needs.nightly-pika.result }}\n"
          fi
          if [[ "${{ needs.nightly-marmotd.result }}" != "success" ]]; then
            echo "nightly-marmotd failed"
            failed="${failed}- **nightly-marmotd**: ${{ needs.nightly-marmotd.result }}\n"
          fi
          if [[ "${{ needs.nightly-pika-ui-android.result }}" != "success" ]]; then
            echo "nightly-pika-ui-android failed"
            failed="${failed}- **nightly-pika-ui-android**: ${{ needs.nightly-pika-ui-android.result }}\n"
          fi
          if [[ -n "$failed" ]]; then
            {
              echo "failed<<EOF"
              echo -e "$failed"
              echo "EOF"
              echo "has_failures=true"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Open issue on failure
        if: steps.check.outputs.has_failures == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Skip creating a duplicate if an open nightly-failure issue already exists
          existing=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "nightly-failure" \
            --state open \
            --limit 1 \
            --json number \
            --jq '.[0].number // empty')

          run_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          date=$(date -u +%Y-%m-%d)

          if [[ -n "$existing" ]]; then
            # Append a comment to the existing issue instead of opening a new one
            gh issue comment "$existing" \
              --repo "${{ github.repository }}" \
              --body "### Nightly still failing — ${date}

          ${{ steps.check.outputs.failed }}
          [Run log](${run_url})"
          else
            gh issue create \
              --repo "${{ github.repository }}" \
              --title "Nightly failure — ${date}" \
              --label "nightly-failure" \
              --body "## Nightly CI failed

          ${{ steps.check.outputs.failed }}
          **Run:** ${run_url}

          This issue was auto-opened by CI. It will stop receiving comments once all nightly lanes pass again."
          fi

      - name: Fail the job
        if: steps.check.outputs.has_failures == 'true'
        run: exit 1
