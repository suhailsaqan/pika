#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
OUTPUT_ENCRYPTED="$ROOT/secrets/zapstore-signing.env.age"
OUTPUT_ENCRYPTED_NEXT="$ROOT/secrets/zapstore-signing.env.age.next"

# shellcheck source=./release-age-recipients
source "$ROOT/scripts/release-age-recipients"

YUBIKEY_PRIMARY="${PIKA_YUBIKEY_PRIMARY_RECIPIENT:-$PIKA_RELEASE_YUBIKEY_PRIMARY_RECIPIENT_DEFAULT}"
YUBIKEY_BACKUP="${PIKA_YUBIKEY_BACKUP_RECIPIENT:-$PIKA_RELEASE_YUBIKEY_BACKUP_RECIPIENT_DEFAULT}"
CI_RECIPIENT="${PIKA_CI_AGE_RECIPIENT:-$PIKA_RELEASE_CI_RECIPIENT_DEFAULT}"

usage() {
  cat <<'USAGE'
usage: ./scripts/encrypt-zapstore-signing

Encrypts `secrets/zapstore-signing.env.age` with:
  - YubiKey primary recipient
  - YubiKey backup recipient
  - CI recipient (from PIKA_CI_AGE_RECIPIENT or repo defaults)

Input:
  - `PIKA_ZAPSTORE_SIGN_WITH` (recommended)
  - or interactive prompt

Environment overrides:
  PIKA_ZAPSTORE_SIGN_WITH
  PIKA_CI_AGE_RECIPIENT
  PIKA_YUBIKEY_PRIMARY_RECIPIENT
  PIKA_YUBIKEY_BACKUP_RECIPIENT
USAGE
}

need_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "error: missing command: $1" >&2
    exit 1
  fi
}

cleanup() {
  rm -f "$OUTPUT_ENCRYPTED_NEXT"
}
trap cleanup EXIT INT TERM

if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
  usage
  exit 0
fi
if [ "$#" -ne 0 ]; then
  usage >&2
  exit 2
fi

need_cmd age

if ! printf '%s\n' "$CI_RECIPIENT" | grep -Eq '^age1[023456789acdefghjklmnpqrstuvwxyz]+$'; then
  echo "error: invalid CI recipient format (expected age1...)" >&2
  exit 1
fi

sign_with="${PIKA_ZAPSTORE_SIGN_WITH:-}"
if [ -z "$sign_with" ]; then
  if [ ! -t 0 ]; then
    echo "error: set PIKA_ZAPSTORE_SIGN_WITH when running non-interactively" >&2
    exit 1
  fi
  read -r -s -p "Enter Zapstore SIGN_WITH (nsec or bunker URL): " sign_with
  printf '\n'
fi

if [ -z "$sign_with" ]; then
  echo "error: missing Zapstore SIGN_WITH value" >&2
  exit 1
fi

mkdir -p "$ROOT/secrets"
umask 077

{
  printf 'ZAPSTORE_SIGN_WITH=%s\n' "$sign_with"
} | age -e \
  -r "$YUBIKEY_PRIMARY" \
  -r "$YUBIKEY_BACKUP" \
  -r "$CI_RECIPIENT" \
  -o "$OUTPUT_ENCRYPTED_NEXT"

chmod 600 "$OUTPUT_ENCRYPTED_NEXT"
mv "$OUTPUT_ENCRYPTED_NEXT" "$OUTPUT_ENCRYPTED"

unset sign_with

echo "ok: wrote $OUTPUT_ENCRYPTED"
echo "ok: recipients:"
echo "  - $YUBIKEY_PRIMARY"
echo "  - $YUBIKEY_BACKUP"
echo "  - $CI_RECIPIENT (CI)"
