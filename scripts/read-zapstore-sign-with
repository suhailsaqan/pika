#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
ENCRYPTED_SIGNING_ENV="$ROOT/secrets/zapstore-signing.env.age"
YUBIKEY_IDENTITY_FILE_DEFAULT="$HOME/configs/yubikeys/keys.txt"
YUBIKEY_IDENTITY_FILE="${PIKA_AGE_IDENTITY_FILE:-$YUBIKEY_IDENTITY_FILE_DEFAULT}"

if [ -n "${ZAPSTORE_SIGN_WITH:-}" ]; then
  printf '%s\n' "$ZAPSTORE_SIGN_WITH"
  exit 0
fi

if ! command -v age >/dev/null 2>&1; then
  echo "error: age is required (run inside nix develop)" >&2
  exit 1
fi

if [ ! -f "$ENCRYPTED_SIGNING_ENV" ]; then
  echo "error: missing encrypted Zapstore signing env: $ENCRYPTED_SIGNING_ENV" >&2
  echo "hint: create it via ./scripts/encrypt-zapstore-signing" >&2
  exit 1
fi

decrypt_to_stdout() {
  if [ -n "${AGE_SECRET_KEY:-}" ]; then
    local tmp_key="$ROOT/secrets/.age-key.zapstore.tmp"
    trap 'rm -f "$tmp_key"' EXIT
    umask 077
    printf '%s\n' "$AGE_SECRET_KEY" >"$tmp_key"
    age -d -i "$tmp_key" "$ENCRYPTED_SIGNING_ENV"
    return 0
  fi
  if [ -f "$YUBIKEY_IDENTITY_FILE" ]; then
    age -d -i "$YUBIKEY_IDENTITY_FILE" "$ENCRYPTED_SIGNING_ENV"
    return 0
  fi
  echo "error: set AGE_SECRET_KEY or provide PIKA_AGE_IDENTITY_FILE (default: $YUBIKEY_IDENTITY_FILE_DEFAULT)" >&2
  exit 1
}

sign_with="$(
  decrypt_to_stdout \
    | sed -n 's/^ZAPSTORE_SIGN_WITH=//p' \
    | head -n 1
)"

if [ -z "$sign_with" ]; then
  echo "error: encrypted signing env is missing ZAPSTORE_SIGN_WITH" >&2
  exit 1
fi

printf '%s\n' "$sign_with"
