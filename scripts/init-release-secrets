#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

KEYSTORE_ENCRYPTED="$ROOT/android/pika-release.jks.age"
PASSWORD_ENCRYPTED="$ROOT/secrets/android-signing.env.age"
ZAPSTORE_SIGNING_ENCRYPTED="$ROOT/secrets/zapstore-signing.env.age"
KEYSTORE_PLAINTEXT="$ROOT/android/pika-release.jks"
KEYSTORE_TEST="$ROOT/android/pika-release.test.jks"
KEYSTORE_ENCRYPTED_NEXT="$ROOT/android/pika-release.jks.age.next"
PASSWORD_ENCRYPTED_NEXT="$ROOT/secrets/android-signing.env.age.next"
ZAPSTORE_SIGNING_ENCRYPTED_NEXT="$ROOT/secrets/zapstore-signing.env.age.next"
CI_KEY_TMP="$ROOT/android/.pika-ci-age.key.tmp"
YUBIKEY_IDENTITY_FILE="${PIKA_AGE_IDENTITY_FILE:-$HOME/configs/yubikeys/yubikey-primary.txt}"

# shellcheck source=./release-age-recipients
source "$ROOT/scripts/release-age-recipients"

YUBIKEY_PRIMARY="${PIKA_YUBIKEY_PRIMARY_RECIPIENT:-$PIKA_RELEASE_YUBIKEY_PRIMARY_RECIPIENT_DEFAULT}"
YUBIKEY_BACKUP="${PIKA_YUBIKEY_BACKUP_RECIPIENT:-$PIKA_RELEASE_YUBIKEY_BACKUP_RECIPIENT_DEFAULT}"
DEFAULT_YUBIKEY_IDENTITY_FILE="$HOME/configs/yubikeys/yubikey-primary.txt"
FALLBACK_YUBIKEY_IDENTITY_FILE="$HOME/configs/yubikeys/keys.txt"
GH_REPO_TARGET="sledtools/pika"

usage() {
  cat <<'EOF'
usage: ./scripts/init-release-secrets

One-shot release bootstrap:
  1. Generate fresh CI age key (ephemeral on local disk).
  2. Generate fresh Android keystore + random password.
  3. Encrypt keystore and password to:
     - YubiKey primary recipient
     - YubiKey backup recipient
     - CI recipient (from fresh key)
  4. Verify decrypt with YubiKey identity file (single-key test).
  5. Set GitHub Actions repo secrets:
     - AGE_SECRET_KEY (only)

Cleanup:
  - Removes plaintext keystores and CI private key temp file on exit.
  - Does not write secrets into /tmp.

Environment overrides:
  PIKA_AGE_IDENTITY_FILE  (tested key; defaults to yubikey-primary identity file)
  PIKA_YUBIKEY_PRIMARY_RECIPIENT
  PIKA_YUBIKEY_BACKUP_RECIPIENT
  PIKA_KEYSTORE_PASSWORD
  PIKA_ZAPSTORE_SIGN_WITH
EOF
}

need_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "error: missing command: $1" >&2
    exit 1
  fi
}

cleanup() {
  rm -f "$KEYSTORE_PLAINTEXT" "$KEYSTORE_TEST" "$CI_KEY_TMP" "$KEYSTORE_ENCRYPTED_NEXT" "$PASSWORD_ENCRYPTED_NEXT" "$ZAPSTORE_SIGNING_ENCRYPTED_NEXT"
}
trap cleanup EXIT INT TERM

if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
  usage
  exit 0
fi
if [ "$#" -ne 0 ]; then
  usage >&2
  exit 2
fi

need_cmd age
need_cmd age-keygen
need_cmd keytool
need_cmd openssl
need_cmd gh
need_cmd grep
need_cmd sed

if [ ! -f "$YUBIKEY_IDENTITY_FILE" ] && [ -f "$DEFAULT_YUBIKEY_IDENTITY_FILE" ]; then
  YUBIKEY_IDENTITY_FILE="$DEFAULT_YUBIKEY_IDENTITY_FILE"
fi
if [ ! -f "$YUBIKEY_IDENTITY_FILE" ] && [ -f "$FALLBACK_YUBIKEY_IDENTITY_FILE" ]; then
  YUBIKEY_IDENTITY_FILE="$FALLBACK_YUBIKEY_IDENTITY_FILE"
fi
if [ ! -f "$YUBIKEY_IDENTITY_FILE" ]; then
  echo "error: missing YubiKey identity file: $YUBIKEY_IDENTITY_FILE" >&2
  exit 1
fi

if ! gh auth status >/dev/null 2>&1; then
  echo "error: gh is not authenticated; run 'gh auth login' first" >&2
  exit 1
fi

mkdir -p "$ROOT/android" "$ROOT/secrets"
umask 077

echo "Generating fresh CI age key..."
rm -f "$CI_KEY_TMP"
age-keygen -o "$CI_KEY_TMP" >/dev/null
chmod 600 "$CI_KEY_TMP"

ci_recipient="$(age-keygen -y "$CI_KEY_TMP")"
ci_secret_key="$(grep '^AGE-SECRET-KEY-' "$CI_KEY_TMP" | head -n 1 || true)"
if [ -z "$ci_secret_key" ]; then
  echo "error: failed to read generated CI secret key" >&2
  exit 1
fi

keystore_password="${PIKA_KEYSTORE_PASSWORD:-}"
if [ -z "$keystore_password" ]; then
  keystore_password="$(openssl rand -base64 48 | tr -d '\n')"
fi

echo "Generating release keystore..."
rm -f "$KEYSTORE_PLAINTEXT"
keytool -genkeypair -v \
  -keystore "$KEYSTORE_PLAINTEXT" \
  -alias pika \
  -keyalg RSA \
  -keysize 2048 \
  -validity 10000 \
  -dname "CN=Pika, O=Pika, L=Unknown, ST=Unknown, C=US" \
  -storepass "$keystore_password" \
  -keypass "$keystore_password" \
  >/dev/null
chmod 600 "$KEYSTORE_PLAINTEXT"

echo "Encrypting keystore to YubiKey primary + YubiKey backup + CI..."
rm -f "$KEYSTORE_ENCRYPTED_NEXT"
age -e \
  -r "$YUBIKEY_PRIMARY" \
  -r "$YUBIKEY_BACKUP" \
  -r "$ci_recipient" \
  -o "$KEYSTORE_ENCRYPTED_NEXT" \
  "$KEYSTORE_PLAINTEXT"
chmod 600 "$KEYSTORE_ENCRYPTED_NEXT"
mv "$KEYSTORE_ENCRYPTED_NEXT" "$KEYSTORE_ENCRYPTED"

echo "Encrypting signing password to recipients..."
rm -f "$PASSWORD_ENCRYPTED_NEXT"
{
  printf 'PIKA_KEYSTORE_PASSWORD=%s\n' "$keystore_password"
} | age -e \
  -r "$YUBIKEY_PRIMARY" \
  -r "$YUBIKEY_BACKUP" \
  -r "$ci_recipient" \
  -o "$PASSWORD_ENCRYPTED_NEXT"
chmod 600 "$PASSWORD_ENCRYPTED_NEXT"
mv "$PASSWORD_ENCRYPTED_NEXT" "$PASSWORD_ENCRYPTED"

if [ -n "${PIKA_ZAPSTORE_SIGN_WITH:-}" ]; then
  echo "Encrypting Zapstore signing env to recipients..."
  rm -f "$ZAPSTORE_SIGNING_ENCRYPTED_NEXT"
  {
    printf 'ZAPSTORE_SIGN_WITH=%s\n' "$PIKA_ZAPSTORE_SIGN_WITH"
  } | age -e \
    -r "$YUBIKEY_PRIMARY" \
    -r "$YUBIKEY_BACKUP" \
    -r "$ci_recipient" \
    -o "$ZAPSTORE_SIGNING_ENCRYPTED_NEXT"
  chmod 600 "$ZAPSTORE_SIGNING_ENCRYPTED_NEXT"
  mv "$ZAPSTORE_SIGNING_ENCRYPTED_NEXT" "$ZAPSTORE_SIGNING_ENCRYPTED"
fi

echo "Testing YubiKey decryption with $YUBIKEY_IDENTITY_FILE (touch/PIN may be required)..."
rm -f "$KEYSTORE_TEST"
age -d -i "$YUBIKEY_IDENTITY_FILE" -o "$KEYSTORE_TEST" "$KEYSTORE_ENCRYPTED"
chmod 600 "$KEYSTORE_TEST"
password_test="$(
  age -d -i "$YUBIKEY_IDENTITY_FILE" "$PASSWORD_ENCRYPTED" \
    | sed -n 's/^PIKA_KEYSTORE_PASSWORD=//p' \
    | head -n 1
)"
if [ -z "$password_test" ]; then
  echo "error: failed to recover PIKA_KEYSTORE_PASSWORD from $PASSWORD_ENCRYPTED" >&2
  exit 1
fi
keytool -list -keystore "$KEYSTORE_TEST" -storepass "$password_test" >/dev/null
unset password_test
unset keystore_password

echo "Setting GitHub secrets (repo-scoped)..."
echo "  - deleting old AGE_SECRET_KEY / PIKA_KEYSTORE_PASSWORD (if present)"
gh secret delete AGE_SECRET_KEY --repo "$GH_REPO_TARGET" >/dev/null 2>&1 || true
gh secret delete PIKA_KEYSTORE_PASSWORD --repo "$GH_REPO_TARGET" >/dev/null 2>&1 || true
echo "  - setting fresh AGE_SECRET_KEY"
gh secret set AGE_SECRET_KEY --repo "$GH_REPO_TARGET" --body "$ci_secret_key" >/dev/null
unset ci_secret_key

echo "ok: wrote $KEYSTORE_ENCRYPTED"
echo "ok: wrote $PASSWORD_ENCRYPTED"
if [ -n "${PIKA_ZAPSTORE_SIGN_WITH:-}" ]; then
  echo "ok: wrote $ZAPSTORE_SIGNING_ENCRYPTED"
else
  echo "note: skipped $ZAPSTORE_SIGNING_ENCRYPTED (set PIKA_ZAPSTORE_SIGN_WITH to include it)"
fi
echo "ok: recipients:"
echo "  - $YUBIKEY_PRIMARY"
echo "  - $YUBIKEY_BACKUP"
echo "  - $ci_recipient (CI)"
echo "ok: YubiKey decrypt test passed"
echo "note: backup recipient is included in encryption but was not separately tested"
echo "ok: GitHub secrets updated for $GH_REPO_TARGET (AGE_SECRET_KEY)"
