#!/usr/bin/env bash
set -euo pipefail
set +x

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
DEFAULT_REPO_URL="https://github.com/sledtools/pika"
DEFAULT_ZAPSTORE_APP_URL="https://zapstore.dev/apps/naddr1qqfkxmmd9e482um5d9hx6mm0dch8q6ttvyq3samnwvaz7tmjv4kxz7fw0fshqum5daex2tnyv4mqyg8g38vsur6pyts9uv5357r2sxujmyl54ugvetfduyvp80hgh6yzcspsgqqq0c9shze8tx"

usage() {
  cat <<'USAGE'
usage: ./scripts/post-release-announcement <tag> [repo-url] [zapstore-app-url]

Publishes a kind-1 Nostr release announcement for a Git tag release.

Arguments:
  tag               Release tag (e.g. pika/v0.2.5)
  repo-url          Optional repository URL (default: https://github.com/sledtools/pika)
  zapstore-app-url  Optional Zapstore app URL (default: https://zapstore.dev/apps/naddr1qqfkxmmd9e482um5d9hx6mm0dch8q6ttvyq3samnwvaz7tmjv4kxz7fw0fshqum5daex2tnyv4mqyg8g38vsur6pyts9uv5357r2sxujmyl54ugvetfduyvp80hgh6yzcspsgqqq0c9shze8tx)

Environment:
  PIKA_ANNOUNCE_RELAYS  Space-delimited relay list override
USAGE
}

need_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "error: missing command: $1" >&2
    exit 1
  fi
}

if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
  usage
  exit 0
fi

if [ "$#" -lt 1 ] || [ "$#" -gt 3 ]; then
  usage >&2
  exit 2
fi

need_cmd nak
need_cmd tr
need_cmd jq

tag="$1"
repo_url="${2:-$DEFAULT_REPO_URL}"
zapstore_app_url="${3:-$DEFAULT_ZAPSTORE_APP_URL}"

if ! printf '%s\n' "$tag" | grep -Eq '^pika/v[0-9]+\.[0-9]+\.[0-9]+$'; then
  echo "error: invalid tag format: $tag (expected pika/vX.Y.Z)" >&2
  exit 1
fi
tag_url="${tag//\//%2F}"

sign_with="$(cd "$ROOT" && ./scripts/read-zapstore-sign-with | tr -d '\r\n')"
if [ -z "$sign_with" ]; then
  echo "error: decrypted Zapstore signing value is empty" >&2
  exit 1
fi

if [ "${GITHUB_ACTIONS:-}" = "true" ]; then
  printf '::add-mask::%s\n' "$sign_with"
fi

content="Pika ${tag} is live.
Android APK + macOS DMG are available.
Install on Zapstore: ${zapstore_app_url}
GitHub release: ${repo_url}/releases/tag/${tag_url}"

if [ -n "${PIKA_ANNOUNCE_RELAYS:-}" ]; then
  IFS=' ' read -r -a relays <<<"${PIKA_ANNOUNCE_RELAYS}"
else
  relays=(
    "wss://relay.primal.net"
    "wss://relay.damus.io"
    "wss://relay.zapstore.dev"
    "wss://nos.lol"
    "wss://relay.nostr.band"
  )
fi

if [ "${#relays[@]}" -eq 0 ]; then
  echo "error: no relays configured for announcement" >&2
  exit 1
fi

event_json="$(NOSTR_SECRET_KEY="$sign_with" nak event -k 1 -c "$content" < /dev/null)"
event_id="$(printf '%s' "$event_json" | jq -r '.id // empty')"
if [ -z "$event_id" ]; then
  echo "error: failed to derive announcement event id from nak output" >&2
  exit 1
fi

printf '%s\n' "$event_json" | NOSTR_SECRET_KEY="$sign_with" nak -q event "${relays[@]}" >/dev/null

published_on=""
for relay in "${relays[@]}"; do
  if nak -q req -i "$event_id" -l 1 "$relay" < /dev/null | jq -e --arg id "$event_id" 'select(.id == $id)' >/dev/null 2>&1; then
    published_on="$relay"
    break
  fi
done

if [ -z "$published_on" ]; then
  echo "error: announcement event was not retrievable from any target relay" >&2
  echo "event_id=$event_id" >&2
  printf 'relays=%s\n' "${relays[*]}" >&2
  exit 1
fi

echo "ok: announcement published event_id=$event_id relay=$published_on"
unset sign_with
