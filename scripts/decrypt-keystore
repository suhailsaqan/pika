#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
ENCRYPTED_KEYSTORE="$ROOT/android/pika-release.jks.age"
OUTPUT_KEYSTORE="$ROOT/android/pika-release.jks"
YUBIKEY_IDENTITY_FILE_DEFAULT="$HOME/configs/yubikeys/keys.txt"
YUBIKEY_IDENTITY_FILE="${PIKA_AGE_IDENTITY_FILE:-$YUBIKEY_IDENTITY_FILE_DEFAULT}"

# shellcheck disable=SC1091
source "$ROOT/tools/lib/dotenv.sh"
load_dotenv_no_override "$ROOT"

if ! command -v age >/dev/null 2>&1; then
  echo "error: age is required (run inside nix develop)" >&2
  exit 1
fi

if [ ! -f "$ENCRYPTED_KEYSTORE" ]; then
  echo "error: missing encrypted keystore: $ENCRYPTED_KEYSTORE" >&2
  echo "hint: create it once and commit android/pika-release.jks.age" >&2
  exit 1
fi

if [ -n "${AGE_SECRET_KEY:-}" ]; then
  umask 077
  tmp_key="$(mktemp "${TMPDIR:-/tmp}/pika-age-key.XXXXXX")"
  trap 'rm -f "$tmp_key"' EXIT
  printf '%s\n' "$AGE_SECRET_KEY" >"$tmp_key"
  age -d -i "$tmp_key" -o "$OUTPUT_KEYSTORE" "$ENCRYPTED_KEYSTORE"
elif [ -f "$YUBIKEY_IDENTITY_FILE" ]; then
  age -d -i "$YUBIKEY_IDENTITY_FILE" -o "$OUTPUT_KEYSTORE" "$ENCRYPTED_KEYSTORE"
else
  echo "error: set AGE_SECRET_KEY or provide PIKA_AGE_IDENTITY_FILE (default: $YUBIKEY_IDENTITY_FILE_DEFAULT)" >&2
  exit 1
fi

chmod 600 "$OUTPUT_KEYSTORE"
echo "ok: decrypted keystore -> $OUTPUT_KEYSTORE"
