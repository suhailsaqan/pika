#!/usr/bin/env bash
set -euo pipefail

# Local-first baseline: prove Pika (this repo) can interop with the Rust OpenClaw-style bot
# from marmot-interop-lab-rust over a local relay.
#
# This script:
# 1) starts a local nostr-rs-relay (nix develop: nostr-rs-relay on PATH)
# 2) starts the rust_harness "bot" (publishes kind 443 + waits for a welcome)
# 3) runs the Pika core baseline client to create a chat and verify `ping` -> `pong`
#
# Run from the Pika repo root, ideally inside `nix develop`.

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT"

KEEP=0
MANUAL=0
while [ "$#" -gt 0 ]; do
  case "$1" in
    --keep)
      KEEP=1
      shift
      ;;
    --manual)
      MANUAL=1
      shift
      ;;
    -h|--help)
      echo "usage: tools/interop-rust-baseline [--manual] [--keep]" >&2
      exit 0
      ;;
    *)
      echo "usage: tools/interop-rust-baseline [--manual] [--keep]" >&2
      exit 2
      ;;
  esac
done

RUST_INTEROP_DIR="${MARMOT_INTEROP_RUST_DIR:-$HOME/code/marmot-interop-lab-rust}"
if [ ! -d "$RUST_INTEROP_DIR" ]; then
  echo "error: missing rust interop repo at: $RUST_INTEROP_DIR" >&2
  echo "hint: set MARMOT_INTEROP_RUST_DIR to the correct path" >&2
  exit 1
fi
MDK_DIR="${MDK_DIR:-$HOME/code/mdk}"

need() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "error: missing '$1' on PATH" >&2
    exit 1
  fi
}
need nostr-rs-relay
need cargo

if [ -d "$MDK_DIR/.git" ]; then
  mdk_head="$(cd "$MDK_DIR" && git rev-parse HEAD 2>/dev/null || true)"
  harness_rev="$(
    sed -n 's/^mdk-core = .*rev = \"\\([0-9a-f]\\{40\\}\\)\".*/\\1/p' \
      "$RUST_INTEROP_DIR/rust_harness/Cargo.toml" | head -n 1
  )"
  if [ -n "${mdk_head:-}" ] && [ -n "${harness_rev:-}" ] && [ "$mdk_head" != "$harness_rev" ]; then
    echo "error: MDK version skew detected" >&2
    echo "  pika uses local MDK at: $MDK_DIR (HEAD=$mdk_head)" >&2
    echo "  rust harness pins MDK rev: $harness_rev" >&2
    echo "fix: align one side before interop conclusions" >&2
    exit 1
  fi
  if [ -n "${mdk_head:-}" ] && [ -n "${harness_rev:-}" ]; then
    echo "ok: MDK rev aligned: $mdk_head"
  fi
fi

if [ -n "${PIKA_INTEROP_STATE_DIR:-}" ]; then
  STATE_DIR="${PIKA_INTEROP_STATE_DIR}"
  mkdir -p "$STATE_DIR"
else
  STATE_DIR="$(mktemp -d /tmp/pika-interop-rustbot.XXXXXX)"
fi

BOT_LOG="${STATE_DIR}/rustbot.log"
BOT_TIMEOUT_SEC="${BOT_TIMEOUT_SEC:-900}"

cleanup() {
  if [ -n "${BOT_PID:-}" ]; then
    kill "${BOT_PID}" >/dev/null 2>&1 || true
    # Avoid "Terminated: 15" noise from bash job control on exit.
    wait "${BOT_PID}" >/dev/null 2>&1 || true
  fi
  if [ -n "${RELAY_PID:-}" ]; then
    kill "${RELAY_PID}" >/dev/null 2>&1 || true
    wait "${RELAY_PID}" >/dev/null 2>&1 || true
  fi
  if [ "$KEEP" -eq 0 ] && [ -z "${PIKA_INTEROP_STATE_DIR:-}" ]; then
    rm -rf "$STATE_DIR" >/dev/null 2>&1 || true
  fi
}
trap cleanup EXIT

RELAY_PORT="$(
  python3 - <<'PY'
import socket
s=socket.socket()
s.bind(("127.0.0.1",0))
print(s.getsockname()[1])
s.close()
PY
)"

RELAY_DB_DIR="${STATE_DIR}/relay-db"
mkdir -p "$RELAY_DB_DIR"
RELAY_CONFIG="${RUST_INTEROP_DIR}/relay/nostr-rs-relay-config.toml"
if [ ! -f "$RELAY_CONFIG" ]; then
  echo "error: missing relay config: $RELAY_CONFIG" >&2
  exit 1
fi

RELAY_CONFIG_TMP="${STATE_DIR}/relay-config.toml"
sed -E \
  -e "s|^relay_url = \\\".*\\\"|relay_url = \\\"ws://127.0.0.1:${RELAY_PORT}\\\"|g" \
  -e "s|^port = [0-9]+|port = ${RELAY_PORT}|g" \
  -e "s|^data_directory = \\\".*\\\"|data_directory = \\\"${RELAY_DB_DIR}\\\"|g" \
  "${RELAY_CONFIG}" > "${RELAY_CONFIG_TMP}"

RELAY_LOG="${STATE_DIR}/relay.log"
echo "starting local relay (nostr-rs-relay) state_dir=$STATE_DIR port=$RELAY_PORT"
nostr-rs-relay --db "${RELAY_DB_DIR}" --config "${RELAY_CONFIG_TMP}" >"${RELAY_LOG}" 2>&1 &
RELAY_PID="$!"

for _ in $(seq 1 200); do
  if (echo >"/dev/tcp/127.0.0.1/${RELAY_PORT}") >/dev/null 2>&1; then
    break
  fi
  sleep 0.05
done

RELAY_URL="ws://127.0.0.1:${RELAY_PORT}"
ANDROID_RELAY_URL="ws://10.0.2.2:${RELAY_PORT}"

echo "relay_url=${RELAY_URL}"
echo "android_relay_url=${ANDROID_RELAY_URL}"

rm -f "$BOT_LOG"
echo "starting rust bot (logs at: $BOT_LOG)"
(
  cd "$RUST_INTEROP_DIR"
  cargo run -q -p rust_harness -- bot --relay "$RELAY_URL" --state-dir "${STATE_DIR}/bot" --timeout-sec "$BOT_TIMEOUT_SEC"
) >"$BOT_LOG" 2>&1 &
BOT_PID="$!"

BOT_NPUB=""
BOT_PUBKEY=""
for i in $(seq 1 1200); do
  if [ -s "$BOT_LOG" ]; then
    # Example line:
    #   [openclaw_bot] ready pubkey=<hex> npub=<npub>
    line="$(grep -E "\\[openclaw_bot\\] ready pubkey=" "$BOT_LOG" | tail -n 1 || true)"
    if [ -n "${line:-}" ]; then
      # Parse without regex tooling to avoid environment-specific sed quirks.
      BOT_PUBKEY="${line#*pubkey=}"
      BOT_PUBKEY="${BOT_PUBKEY%% *}"
      BOT_NPUB="${line#*npub=}"
      BOT_NPUB="${BOT_NPUB%% *}"
      if [ -n "${BOT_PUBKEY:-}" ] && [ -n "${BOT_NPUB:-}" ]; then
        break
      fi
    fi
  fi
  if ! kill -0 "$BOT_PID" >/dev/null 2>&1; then
    echo "error: rust bot exited early; last logs:" >&2
    tail -n 120 "$BOT_LOG" >&2 || true
    exit 1
  fi
  sleep 0.5
done

if [ -z "${BOT_NPUB:-}" ]; then
  echo "error: failed to detect bot identity from logs; last logs:" >&2
  tail -n 160 "$BOT_LOG" >&2 || true
  exit 1
fi

echo "bot_npub=${BOT_NPUB}"
echo "bot_pubkey_hex=${BOT_PUBKEY}"

if [ "$MANUAL" -eq 0 ]; then
  echo "running pika_core baseline against rust bot..."
  cargo run -q -p pika_core --bin interop_rustbot_baseline -- "$RELAY_URL" "$BOT_NPUB"
fi

cat <<EOF

Manual validation (Android emulator):
- Run: PIKA_RELAY_URLS="$ANDROID_RELAY_URL" just run-android
- In-app: Create Account -> New Chat -> paste bot_npub -> Start Chat -> send "ping" -> expect "pong"

Manual validation (iOS simulator):
- Run: PIKA_RELAY_URLS="$RELAY_URL" just run-ios
- Same in-app flow as above

Bot logs: $BOT_LOG
EOF

if [ "$MANUAL" -eq 1 ]; then
  echo
  echo "manual mode: keeping relay+bot running; press Ctrl-C to stop."
  tail -f "$BOT_LOG"
fi
