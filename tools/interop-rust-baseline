#!/usr/bin/env bash
set -euo pipefail

# Local-first baseline: prove Pika (this repo) can interop with the Rust OpenClaw-style bot
# from marmot-interop-lab-rust over a local relay.
#
# This script:
# 1) starts a local nostr-rs-relay (nix develop: nostr-rs-relay on PATH)
# 2) starts the rust_harness "bot" (publishes kind 443 + waits for a welcome)
# 3) runs the Pika core baseline client to create a chat and verify `ping` -> `pong`
#
# Run from the Pika repo root, ideally inside `nix develop`.

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT"
source "$ROOT/tools/lib/local-e2e-fixture.sh"

KEEP=0
MANUAL=0
while [ "$#" -gt 0 ]; do
  case "$1" in
    --keep)
      KEEP=1
      shift
      ;;
    --manual)
      MANUAL=1
      shift
      ;;
    -h|--help)
      echo "usage: tools/interop-rust-baseline [--manual] [--keep]" >&2
      exit 0
      ;;
    *)
      echo "usage: tools/interop-rust-baseline [--manual] [--keep]" >&2
      exit 2
      ;;
  esac
done

RUST_INTEROP_DIR="${PIKACHAT_INTEROP_RUST_DIR:-$HOME/code/marmot-interop-lab-rust}"
if [ ! -d "$RUST_INTEROP_DIR" ]; then
  echo "error: missing rust interop repo at: $RUST_INTEROP_DIR" >&2
  echo "hint: set PIKACHAT_INTEROP_RUST_DIR to the correct path" >&2
  exit 1
fi
MDK_DIR="${MDK_DIR:-$HOME/code/mdk}"

pika_fixture_need nostr-rs-relay
pika_fixture_need cargo

if [ -d "$MDK_DIR/.git" ]; then
  mdk_head="$(cd "$MDK_DIR" && git rev-parse HEAD 2>/dev/null || true)"
  harness_rev="$(
    sed -n 's/^mdk-core = .*rev = \"\\([0-9a-f]\\{40\\}\\)\".*/\\1/p' \
      "$RUST_INTEROP_DIR/rust_harness/Cargo.toml" | head -n 1
  )"
  if [ -n "${mdk_head:-}" ] && [ -n "${harness_rev:-}" ] && [ "$mdk_head" != "$harness_rev" ]; then
    echo "error: MDK version skew detected" >&2
    echo "  pika uses local MDK at: $MDK_DIR (HEAD=$mdk_head)" >&2
    echo "  rust harness pins MDK rev: $harness_rev" >&2
    echo "fix: align one side before interop conclusions" >&2
    exit 1
  fi
  if [ -n "${mdk_head:-}" ] && [ -n "${harness_rev:-}" ]; then
    echo "ok: MDK rev aligned: $mdk_head"
  fi
fi

if [ -n "${PIKA_INTEROP_STATE_DIR:-}" ]; then
  STATE_DIR="${PIKA_INTEROP_STATE_DIR}"
  mkdir -p "$STATE_DIR"
else
  STATE_DIR="$(mktemp -d /tmp/pika-interop-rustbot.XXXXXX)"
fi

BOT_LOG="${STATE_DIR}/rustbot.log"
BOT_TIMEOUT_SEC="${BOT_TIMEOUT_SEC:-900}"

cleanup() {
  if [ -n "${BOT_PID:-}" ]; then
    kill "${BOT_PID}" >/dev/null 2>&1 || true
    # Avoid "Terminated: 15" noise from bash job control on exit.
    wait "${BOT_PID}" >/dev/null 2>&1 || true
  fi
  if [ -n "${RELAY_PID:-}" ]; then
    kill "${RELAY_PID}" >/dev/null 2>&1 || true
    wait "${RELAY_PID}" >/dev/null 2>&1 || true
  fi
  if [ "$KEEP" -eq 0 ] && [ -z "${PIKA_INTEROP_STATE_DIR:-}" ]; then
    rm -rf "$STATE_DIR" >/dev/null 2>&1 || true
  fi
}
trap cleanup EXIT

RELAY_PORT="$(pika_fixture_pick_free_port)"

RELAY_DB_DIR="${STATE_DIR}/relay-db"
mkdir -p "$RELAY_DB_DIR"
RELAY_CONFIG="${RUST_INTEROP_DIR}/relay/nostr-rs-relay-config.toml"
if [ ! -f "$RELAY_CONFIG" ]; then
  echo "error: missing relay config: $RELAY_CONFIG" >&2
  exit 1
fi

RELAY_CONFIG_TMP="${STATE_DIR}/relay-config.toml"
pika_fixture_rewrite_relay_config "${RELAY_CONFIG}" "${RELAY_CONFIG_TMP}" "${RELAY_PORT}" "${RELAY_DB_DIR}"

RELAY_LOG="${STATE_DIR}/relay.log"
echo "starting local relay (nostr-rs-relay) state_dir=$STATE_DIR port=$RELAY_PORT"
pika_fixture_start_relay "${RELAY_DB_DIR}" "${RELAY_CONFIG_TMP}" "${RELAY_LOG}"
RELAY_PID="${PIKA_FIXTURE_RELAY_PID}"
if ! pika_fixture_wait_for_tcp "127.0.0.1" "${RELAY_PORT}" 200 0.05; then
  echo "error: local relay did not become reachable on port ${RELAY_PORT}" >&2
  exit 1
fi

RELAY_URL="ws://127.0.0.1:${RELAY_PORT}"
ANDROID_RELAY_URL="ws://10.0.2.2:${RELAY_PORT}"

echo "relay_url=${RELAY_URL}"
echo "android_relay_url=${ANDROID_RELAY_URL}"

echo "starting rust bot (logs at: $BOT_LOG)"
if ! pika_fixture_start_bot_and_wait \
  "${BOT_LOG}" \
  "\\[openclaw_bot\\] ready pubkey=" \
  1200 \
  0.5 \
  bash -lc "cd \"${RUST_INTEROP_DIR}\" && cargo run -q -p rust_harness -- bot --relay \"${RELAY_URL}\" --state-dir \"${STATE_DIR}/bot\" --timeout-sec \"${BOT_TIMEOUT_SEC}\""; then
  exit 1
fi
BOT_PID="${PIKA_FIXTURE_BOT_PID}"
BOT_NPUB="${PIKA_FIXTURE_BOT_NPUB}"
BOT_PUBKEY="${PIKA_FIXTURE_BOT_PUBKEY}"

echo "bot_npub=${BOT_NPUB}"
echo "bot_pubkey_hex=${BOT_PUBKEY}"

if [ "$MANUAL" -eq 0 ]; then
  echo "running pika_core baseline against rust bot..."
  cargo run -q -p pika_core --bin interop_rustbot_baseline -- "$RELAY_URL" "$BOT_NPUB"
fi

cat <<EOF

Manual validation (Android emulator):
- Run: PIKA_RELAY_URLS="$ANDROID_RELAY_URL" just run-android
- In-app: Create Account -> New Chat -> paste bot_npub -> Start Chat -> send "ping" -> expect "pong"

Manual validation (iOS simulator):
- Run: PIKA_RELAY_URLS="$RELAY_URL" just run-ios
- Same in-app flow as above

Bot logs: $BOT_LOG
EOF

if [ "$MANUAL" -eq 1 ]; then
  echo
  echo "manual mode: keeping relay+bot running; press Ctrl-C to stop."
  tail -f "$BOT_LOG"
fi
