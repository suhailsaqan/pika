#!/usr/bin/env bash
set -euo pipefail

# Deterministic local E2E UI runner:
# - starts a local pika-relay + Rust bot via pikahub
# - runs platform UI E2E tests against that relay+bot
#
# Usage:
#   tools/ui-e2e-local --platform android
#   tools/ui-e2e-local --platform ios
#   tools/ui-e2e-local --platform desktop
#
# Env:
#   BOT_TIMEOUT_SEC=900
#   KEEP=1                         # don't delete temp state dir

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT"
. tools/lib/pikahub.sh

platform=""
KEEP="${KEEP:-0}"
BOT_TIMEOUT_SEC="${BOT_TIMEOUT_SEC:-900}"

usage() {
  cat >&2 <<EOF
usage: tools/ui-e2e-local --platform android|ios|desktop

Starts a local relay+bot and runs the platform UI E2E ping/pong test.
EOF
}

while [ "$#" -gt 0 ]; do
  case "$1" in
    --platform)
      platform="${2:-}"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      usage
      exit 2
      ;;
  esac
done

if [ -z "${platform:-}" ]; then
  usage
  exit 2
fi

# CI determinism: the nightly Android UI E2E lane requires an emulator + a specific AVD.
if [ "$platform" = "android" ]; then
  ADB_BIN="${ADB:-adb}"
  EMULATOR_BIN="${EMULATOR:-emulator}"
  AVD_NAME="${PIKA_ANDROID_AVD_NAME:-pika_api35}"

  if ! command -v "$ADB_BIN" >/dev/null 2>&1 || ! command -v "$EMULATOR_BIN" >/dev/null 2>&1; then
    if [ -n "${CI:-}" ] || [ -n "${GITHUB_ACTIONS:-}" ]; then
      echo "SKIP: android ui e2e local requires adb+emulator on PATH" >&2
      exit 0
    fi
    echo "error: missing adb/emulator on PATH. Run inside \`nix develop\`." >&2
    exit 1
  fi

  avds="$("$EMULATOR_BIN" -list-avds 2>/dev/null || true)"
  if ! printf '%s\n' "$avds" | grep -Fqx "$AVD_NAME"; then
    if [ -n "${CI:-}" ] || [ -n "${GITHUB_ACTIONS:-}" ]; then
      echo "SKIP: android ui e2e local requires AVD '$AVD_NAME' (not present on this runner)" >&2
      echo "tip: provision an AVD or set PIKA_ANDROID_AVD_NAME to an existing AVD" >&2
      exit 0
    fi
    echo "error: android AVD '$AVD_NAME' not found (set PIKA_ANDROID_AVD_NAME or create an AVD)" >&2
    "$EMULATOR_BIN" -list-avds >&2 || true
    exit 1
  fi
fi

STATE_DIR="$(mktemp -d /tmp/pika-ui-e2e-local.XXXXXX)"

cleanup() {
  if [ "${KEEP}" != "1" ]; then
    pikahub_down "$STATE_DIR"
  else
    pikahub_stop "$STATE_DIR"
    echo "note: keeping state dir: ${STATE_DIR}" >&2
  fi
}
trap cleanup EXIT

# ── Start relay + bot via pikahub ───────────────────────────────────────

FIXTURE_CONFIG="$STATE_DIR/fixture-config.toml"
cat > "$FIXTURE_CONFIG" <<EOF
[bot]
timeout_secs = ${BOT_TIMEOUT_SEC}
EOF

pikahub_up relay-bot "$STATE_DIR" --config "$FIXTURE_CONFIG"
BOT_NPUB="$(pikahub_manifest_field bot_npub)"

ANDROID_RELAY_URL="ws://10.0.2.2:${RELAY_PORT}"

echo "relay_url=${RELAY_URL}"
echo "android_relay_url=${ANDROID_RELAY_URL}"
echo "bot_npub=${BOT_NPUB}"

# ── Client identity ─────────────────────────────────────────────────────────

# Deterministic local test identity. This is NOT used for public relays.
if [ -n "${PIKA_UI_E2E_NSEC:-}" ]; then
  CLIENT_NSEC="${PIKA_UI_E2E_NSEC}"
elif [ -f "${ROOT}/.pikachat-test-nsec" ]; then
  CLIENT_NSEC="$(tr -d '\n\r' < "${ROOT}/.pikachat-test-nsec")"
else
  CLIENT_NSEC="$(python3 -c "
import secrets
CHARSET='qpzry9x8gf2tvdw0s3jn54khce6mua7l'
def bech32_polymod(values):
  GEN=[0x3b6a57b2,0x26508e6d,0x1ea119fa,0x3d4233dd,0x2a1462b3]
  chk=1
  for v in values:
    b=chk>>25;chk=((chk&0x1ffffff)<<5)^v
    for i in range(5): chk^=GEN[i] if((b>>i)&1)else 0
  return chk
def bech32_hrp_expand(hrp):
  return [ord(x)>>5 for x in hrp]+[0]+[ord(x)&31 for x in hrp]
def bech32_create_checksum(hrp,data):
  values=bech32_hrp_expand(hrp)+data
  polymod=bech32_polymod(values+[0,0,0,0,0,0])^1
  return [(polymod>>5*(5-i))&31 for i in range(6)]
def convertbits(data,frombits,tobits,pad=True):
  acc=0;bits=0;ret=[];maxv=(1<<tobits)-1
  for b in data:
    acc=(acc<<frombits)|b;bits+=frombits
    while bits>=tobits: bits-=tobits;ret.append((acc>>bits)&maxv)
  if pad and bits: ret.append((acc<<(tobits-bits))&maxv)
  return ret
sk=secrets.token_bytes(32)
data5=convertbits(list(sk),8,5,True)
combined=data5+bech32_create_checksum('nsec',data5)
print('nsec'+'1'+''.join([CHARSET[d] for d in combined]))
")"
  echo "note: generated ephemeral local e2e nsec (set PIKA_UI_E2E_NSEC or .pikachat-test-nsec to override)" >&2
fi

# ── Run platform tests ──────────────────────────────────────────────────────

case "$platform" in
  android)
    TEST_CLASS="${PIKA_ANDROID_E2E_TEST_CLASS:-com.pika.app.PikaE2eUiTest}"
    TEST_SUFFIX="${PIKA_ANDROID_TEST_APPLICATION_ID_SUFFIX:-.test}"
    TEST_APP_ID="org.pikachat.pika${TEST_SUFFIX}"
    ./tools/android-emulator-ensure >/dev/null
    just gen-kotlin android-rust android-local-properties >/dev/null
    PIKA_ANDROID_APP_ID="${TEST_APP_ID}" ./tools/android-ensure-debug-installable >/dev/null
    (cd android && ./gradlew :app:connectedDebugAndroidTest \
      -PPIKA_ANDROID_APPLICATION_ID_SUFFIX="${TEST_SUFFIX}" \
      -Pandroid.testInstrumentationRunnerArguments.class="${TEST_CLASS}" \
      -Pandroid.testInstrumentationRunnerArguments.pika_e2e=1 \
      -Pandroid.testInstrumentationRunnerArguments.pika_disable_network=false \
      -Pandroid.testInstrumentationRunnerArguments.pika_reset=1 \
      -Pandroid.testInstrumentationRunnerArguments.pika_peer_npub="${BOT_NPUB}" \
      -Pandroid.testInstrumentationRunnerArguments.pika_relay_urls="${ANDROID_RELAY_URL}" \
      -Pandroid.testInstrumentationRunnerArguments.pika_key_package_relay_urls="${ANDROID_RELAY_URL}" \
      -Pandroid.testInstrumentationRunnerArguments.pika_nsec="${CLIENT_NSEC}"
    )
    ;;
  ios)
    just ios-xcframework ios-xcodeproj >/dev/null
    udid="$(
      PIKA_UI_E2E_NSEC="${CLIENT_NSEC}" \
      PIKA_UI_E2E_BOT_NPUB="${BOT_NPUB}" \
      PIKA_UI_E2E_RELAYS="${RELAY_URL}" \
      PIKA_UI_E2E_KP_RELAYS="${RELAY_URL}" \
      ./tools/ios-sim-ensure | sed -n 's/^ok: ios simulator ready (udid=\(.*\))$/\1/p'
    )"
    if [ -z "${udid:-}" ]; then
      echo "error: could not determine simulator udid" >&2
      exit 1
    fi
    PIKA_UI_E2E=1 \
      PIKA_UI_E2E_BOT_NPUB="${BOT_NPUB}" \
      PIKA_UI_E2E_RELAYS="${RELAY_URL}" \
      PIKA_UI_E2E_KP_RELAYS="${RELAY_URL}" \
      PIKA_UI_E2E_NSEC="${CLIENT_NSEC}" \
      ./tools/xcode-run xcodebuild -project ios/Pika.xcodeproj -scheme Pika -destination "id=$udid" test CODE_SIGNING_ALLOWED=NO \
          -only-testing:PikaUITests/PikaUITests/testE2E_deployedRustBot_pingPong
    ;;
  desktop)
    PIKA_UI_E2E=1 \
      PIKA_UI_E2E_BOT_NPUB="${BOT_NPUB}" \
      PIKA_UI_E2E_RELAYS="${RELAY_URL}" \
      PIKA_UI_E2E_KP_RELAYS="${RELAY_URL}" \
      PIKA_UI_E2E_NSEC="${CLIENT_NSEC}" \
      cargo test -p pika-desktop desktop_e2e_local_ping_pong_with_bot -- --ignored --nocapture
    ;;
  *)
    echo "error: invalid platform: $platform" >&2
    exit 2
    ;;
esac
