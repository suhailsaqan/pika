#!/usr/bin/env bash
set -euo pipefail

# Deterministic local E2E UI runner:
# - starts a local nostr-rs-relay (nix develop: nostr-rs-relay on PATH)
# - starts a local Rust "bot" (tools/pika-e2e-bot; implemented via pikachat in this repo)
# - runs platform UI E2E tests against that relay+bot
#
# Usage:
#   tools/ui-e2e-local --platform android
#   tools/ui-e2e-local --platform ios
#   tools/ui-e2e-local --platform desktop
#
# Env:
#   BOT_TIMEOUT_SEC=900
#   KEEP=1                         # don't delete temp state dir

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT"
source "$ROOT/tools/lib/local-e2e-fixture.sh"

platform=""
KEEP="${KEEP:-0}"
BOT_TIMEOUT_SEC="${BOT_TIMEOUT_SEC:-900}"

usage() {
  cat >&2 <<EOF
usage: tools/ui-e2e-local --platform android|ios|desktop

Starts a local relay+bot and runs the platform UI E2E ping/pong test.
EOF
}

while [ "$#" -gt 0 ]; do
  case "$1" in
    --platform)
      platform="${2:-}"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      usage
      exit 2
      ;;
  esac
done

if [ -z "${platform:-}" ]; then
  usage
  exit 2
fi

# CI determinism: the nightly Android UI E2E lane requires an emulator + a specific AVD.
# Some CI runners do not have an AVD pre-created; in that case, skip with a clear note
# rather than failing the whole nightly workflow.
if [ "$platform" = "android" ]; then
  ADB_BIN="${ADB:-adb}"
  EMULATOR_BIN="${EMULATOR:-emulator}"
  AVD_NAME="${PIKA_ANDROID_AVD_NAME:-pika_api35}"

  if ! command -v "$ADB_BIN" >/dev/null 2>&1 || ! command -v "$EMULATOR_BIN" >/dev/null 2>&1; then
    if [ -n "${CI:-}" ] || [ -n "${GITHUB_ACTIONS:-}" ]; then
      echo "SKIP: android ui e2e local requires adb+emulator on PATH" >&2
      exit 0
    fi
    echo "error: missing adb/emulator on PATH. Run inside \`nix develop\`." >&2
    exit 1
  fi

  avds="$("$EMULATOR_BIN" -list-avds 2>/dev/null || true)"
  if ! printf '%s\n' "$avds" | grep -Fqx "$AVD_NAME"; then
    if [ -n "${CI:-}" ] || [ -n "${GITHUB_ACTIONS:-}" ]; then
      echo "SKIP: android ui e2e local requires AVD '$AVD_NAME' (not present on this runner)" >&2
      echo "tip: provision an AVD or set PIKA_ANDROID_AVD_NAME to an existing AVD" >&2
      exit 0
    fi
    echo "error: android AVD '$AVD_NAME' not found (set PIKA_ANDROID_AVD_NAME or create an AVD)" >&2
    "$EMULATOR_BIN" -list-avds >&2 || true
    exit 1
  fi
fi

pika_fixture_need nostr-rs-relay
pika_fixture_need cargo
pika_fixture_need python3

STATE_DIR="$(mktemp -d /tmp/pika-ui-e2e-local.XXXXXX)"
BOT_LOG="${STATE_DIR}/rustbot.log"

cleanup() {
  if [ -n "${BOT_PID:-}" ]; then
    kill "${BOT_PID}" >/dev/null 2>&1 || true
    wait "${BOT_PID}" >/dev/null 2>&1 || true
  fi
  if [ -n "${RELAY_PID:-}" ]; then
    kill "${RELAY_PID}" >/dev/null 2>&1 || true
    wait "${RELAY_PID}" >/dev/null 2>&1 || true
  fi
  if [ "${KEEP}" != "1" ]; then
    rm -rf "${STATE_DIR}" >/dev/null 2>&1 || true
  else
    echo "note: keeping state dir: ${STATE_DIR}" >&2
  fi
}
trap cleanup EXIT

RELAY_PORT="$(pika_fixture_pick_free_port)"

RELAY_DB_DIR="${STATE_DIR}/relay-db"
mkdir -p "$RELAY_DB_DIR"
RELAY_CONFIG="${ROOT}/tools/nostr-rs-relay-config.toml"
if [ ! -f "$RELAY_CONFIG" ]; then
  echo "error: missing relay config: $RELAY_CONFIG" >&2
  exit 1
fi

RELAY_CONFIG_TMP="${STATE_DIR}/relay-config.toml"
pika_fixture_rewrite_relay_config "${RELAY_CONFIG}" "${RELAY_CONFIG_TMP}" "${RELAY_PORT}" "${RELAY_DB_DIR}"

RELAY_LOG="${STATE_DIR}/relay.log"
echo "starting local relay (nostr-rs-relay) port=$RELAY_PORT state_dir=$STATE_DIR"
pika_fixture_start_relay "${RELAY_DB_DIR}" "${RELAY_CONFIG_TMP}" "${RELAY_LOG}"
RELAY_PID="${PIKA_FIXTURE_RELAY_PID}"
if ! pika_fixture_wait_for_tcp "127.0.0.1" "${RELAY_PORT}" 200 0.05; then
  echo "error: local relay did not become reachable on port ${RELAY_PORT}" >&2
  exit 1
fi

RELAY_URL="ws://127.0.0.1:${RELAY_PORT}"
ANDROID_RELAY_URL="ws://10.0.2.2:${RELAY_PORT}"

echo "relay_url=${RELAY_URL}"
echo "android_relay_url=${ANDROID_RELAY_URL}"

echo "starting rust bot (logs at: $BOT_LOG)"
if ! pika_fixture_start_bot_and_wait \
  "${BOT_LOG}" \
  "\\[pika_e2e_bot\\] ready pubkey=" \
  1200 \
  0.5 \
  ./tools/pika-e2e-bot --relay "${RELAY_URL}" --state-dir "${STATE_DIR}/bot" --timeout-sec "${BOT_TIMEOUT_SEC}"; then
  exit 1
fi
BOT_PID="${PIKA_FIXTURE_BOT_PID}"
BOT_NPUB="${PIKA_FIXTURE_BOT_NPUB}"

echo "bot_npub=${BOT_NPUB}"

# Deterministic local test identity. This is NOT used for public relays.
generated_nsec=0
if [ -z "${PIKA_UI_E2E_NSEC:-}" ] && [ ! -f "${ROOT}/.pikachat-test-nsec" ]; then
  generated_nsec=1
fi
CLIENT_NSEC="$(pika_fixture_client_nsec "${ROOT}")"
if [ "${generated_nsec}" = "1" ]; then
  echo "note: generated ephemeral local e2e nsec (set PIKA_UI_E2E_NSEC or .pikachat-test-nsec to override)" >&2
fi

case "$platform" in
  android)
    # Default to the full class locally; allow CI or callers to narrow to a stable method.
    TEST_CLASS="${PIKA_ANDROID_E2E_TEST_CLASS:-com.pika.app.PikaE2eUiTest}"
    ./tools/android-emulator-ensure >/dev/null
    just gen-kotlin android-rust android-local-properties >/dev/null
    (cd android && ./gradlew :app:connectedDebugAndroidTest \
      -Pandroid.testInstrumentationRunnerArguments.class="${TEST_CLASS}" \
      -Pandroid.testInstrumentationRunnerArguments.pika_e2e=1 \
      -Pandroid.testInstrumentationRunnerArguments.pika_disable_network=false \
      -Pandroid.testInstrumentationRunnerArguments.pika_reset=1 \
      -Pandroid.testInstrumentationRunnerArguments.pika_peer_npub="${BOT_NPUB}" \
      -Pandroid.testInstrumentationRunnerArguments.pika_relay_urls="${ANDROID_RELAY_URL}" \
      -Pandroid.testInstrumentationRunnerArguments.pika_key_package_relay_urls="${ANDROID_RELAY_URL}" \
      -Pandroid.testInstrumentationRunnerArguments.pika_nsec="${CLIENT_NSEC}"
    )
    ;;
  ios)
    just ios-xcframework ios-xcodeproj >/dev/null
    udid="$(
      PIKA_UI_E2E_NSEC="${CLIENT_NSEC}" \
      PIKA_UI_E2E_BOT_NPUB="${BOT_NPUB}" \
      PIKA_UI_E2E_RELAYS="${RELAY_URL}" \
      PIKA_UI_E2E_KP_RELAYS="${RELAY_URL}" \
      ./tools/ios-sim-ensure | sed -n 's/^ok: ios simulator ready (udid=\(.*\))$/\1/p'
    )"
    if [ -z "${udid:-}" ]; then
      echo "error: could not determine simulator udid" >&2
      exit 1
    fi
    PIKA_UI_E2E=1 \
      PIKA_UI_E2E_BOT_NPUB="${BOT_NPUB}" \
      PIKA_UI_E2E_RELAYS="${RELAY_URL}" \
      PIKA_UI_E2E_KP_RELAYS="${RELAY_URL}" \
      PIKA_UI_E2E_NSEC="${CLIENT_NSEC}" \
      ./tools/xcode-run xcodebuild -project ios/Pika.xcodeproj -scheme Pika -destination "id=$udid" test CODE_SIGNING_ALLOWED=NO \
          -only-testing:PikaUITests/PikaUITests/testE2E_deployedRustBot_pingPong
    ;;
  desktop)
    PIKA_UI_E2E=1 \
      PIKA_UI_E2E_BOT_NPUB="${BOT_NPUB}" \
      PIKA_UI_E2E_RELAYS="${RELAY_URL}" \
      PIKA_UI_E2E_KP_RELAYS="${RELAY_URL}" \
      PIKA_UI_E2E_NSEC="${CLIENT_NSEC}" \
      cargo test -p pika-desktop desktop_e2e_local_ping_pong_with_bot -- --ignored --nocapture
    ;;
  *)
    echo "error: invalid platform: $platform" >&2
    exit 2
    ;;
esac
