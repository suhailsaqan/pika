#!/usr/bin/env bash
set -euo pipefail

# Explain how to get an iOS Simulator runtime installed.
# We intentionally do NOT auto-install by default because it can require
# Apple credentials and downloads many GB.

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT"

DEV_DIR="$("$ROOT/tools/xcode-dev-dir")"
export DEVELOPER_DIR="$DEV_DIR"

SIMCTL="$DEV_DIR/usr/bin/simctl"

has_runtimes() {
  # `simctl list runtimes` prints a header line, then entries (or nothing).
  [ -n "$("$SIMCTL" list runtimes | sed -n '2,$p' | tr -d '[:space:]')" ]
}

if has_runtimes; then
  echo "ok: iOS Simulator runtimes are installed."
  "$SIMCTL" list runtimes | sed -n '1,40p' || true
  exit 0
fi

XCODES_BIN="$(command -v xcodes 2>/dev/null || true)"
LATEST_IOS_RUNTIME_NAME=""
if [ -n "${XCODES_BIN:-}" ]; then
  # `xcodes runtimes` prints a sectioned list:
  #   -- iOS --
  #   iOS 18.6
  #   ...
  # Keep this best-effort; don't fail the doctor if xcodes can't fetch.
  ios_versions="$("$XCODES_BIN" runtimes 2>/dev/null | awk '
    $0=="-- iOS --" {in_ios=1; next}
    /^-- / {in_ios=0}
    in_ios && /^iOS[[:space:]]+[0-9]/ {sub(/^iOS[[:space:]]+/, "", $0); print $0}
  ' || true)"
  if [ -n "${ios_versions:-}" ]; then
    latest_ver="$(printf '%s\n' "$ios_versions" | sort -Vu | tail -n 1 || true)"
    if [ -n "${latest_ver:-}" ]; then
      LATEST_IOS_RUNTIME_NAME="iOS $latest_ver"
    fi
  fi
fi

cat >&2 <<EOF
error: No iOS Simulator runtimes installed (simctl list runtimes is empty).

Pika can build the iOS simulator app, but it cannot boot a simulator without an iOS runtime.

Recommended (most reliable):
  1) Open Xcode
  2) Xcode -> Settings -> Platforms
  3) Download an "iOS Simulator" runtime

Optional (scriptable) if you have the \`xcodes\` tool installed:
  1) List runtimes:   xcodes runtimes
  2) Install one:     xcodes runtimes install "<runtime name>"
     Example:         xcodes runtimes install "${LATEST_IOS_RUNTIME_NAME:-iOS <latest>}"
  Notes:
  - This can require Apple ID auth (xcodes will prompt).
  - Downloads are large (many GB).

Alternative (advanced/offline):
  - If you already have a runtime image artifact, you can add it with:
      xcrun simctl runtime add <path-to-runtime.dmg-or-pkg>

After installing a runtime, retry:
  just run-ios
  just ios-ui-test
EOF

exit 1
